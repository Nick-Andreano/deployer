# Copyright (c) 2024, Itential, Inc
# GNU General Public License v3.0+ (see LICENSE or https://www.gnu.org/licenses/gpl-3.0.txt)
---
- name: Generate certs on all platform hosts
  hosts: platform
  become: true
  roles:
    # Pull in the common vars
    - role: itential.deployer.common
      tags: always
    - role: self_signed_cert

- name: Copy all platform certs to all redis and redis secondary hosts
  hosts: redis
  become: true
  roles:
    # Pull in the common vars
    - role: itential.deployer.common
      tags: always
  tasks:
    - name: Create cert storage directory
      ansible.builtin.file:
        path: "{{ self_signed_cert_dir }}"
        state: directory
        mode: '0755'

    - name: Debug
      ansible.builtin.debug:
        msg: self_signed_cert_dir {{ self_signed_cert_dir }} self_signed_cert_crt {{ self_signed_cert_crt }}

    - name: Fetch certs from all platform hosts
      run_once: true
      delegate_to: "{{ item }}"
      ansible.builtin.fetch:
        src: "{{ self_signed_cert_dir }}/{{ self_signed_cert_crt }}"
        dest: "/tmp/{{ item }}.crt"
        flat: true
      with_items: "{{ groups['platform'] }}"

    - name: Copy fetched certs into redis hosts
      ansible.builtin.copy:
        src: "/tmp/{{ item }}.crt"
        dest: "{{ self_signed_cert_dir }}/{{ self_signed_cert_crt }}"
        mode: '0644'
      with_items: "{{ groups['platform'] }}"
